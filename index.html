<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKTyping</title>
    <link
      rel="icon"
      href="https://i.postimg.cc/vZKR0xtD/typing.png"
      type="image/jpeg"
    />
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Load Google Fonts: Hanuman for Khmer -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hanuman:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Hanuman', sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // Added onDisconnect, onValue, serverTimestamp imports
        import { getDatabase, ref, set, get, child, onDisconnect, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const { useState, useEffect, useRef } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCClq3kieix1eDgZkxx-RnBIUG1spdQkHQ",
            authDomain: "mktyping-19d0a.firebaseapp.com",
            projectId: "mktyping-19d0a",
            storageBucket: "mktyping-19d0a.firebasestorage.app",
            messagingSenderId: "72913605220",
            appId: "1:72913605220:web:5a20fcd2762deda78a4571",
            measurementId: "G-H85KTXXB5P"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- ICONS COMPONENTS ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const KeyboardIcon = (props) => <Icon {...props} path={<><rect width="20" height="16" x="2" y="4" rx="2" ry="2"/><path d="M6 8h.001"/><path d="M10 8h.001"/><path d="M14 8h.001"/><path d="M18 8h.001"/><path d="M6 12h.001"/><path d="M10 12h.001"/><path d="M14 12h.001"/><path d="M18 12h.001"/><path d="M7 16h10"/></>} />;
        const GlobeIcon = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></>} />;
        const RefreshCwIcon = (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />;
        const AwardIcon = (props) => <Icon {...props} path={<><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></>} />;
        const AlertCircleIcon = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />;
        const ChevronRightIcon = (props) => <Icon {...props} path={<path d="m9 18 6-6-6-6"/>} />;
        const XCircleIcon = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>} />;
        const BookOpenIcon = (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />;
        const RotateCcwIcon = (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>} />;
        const CheckCircle2Icon = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>} />;
        const AlertTriangleIcon = (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>} />;
        const MonitorIcon = (props) => <Icon {...props} path={<><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></>} />;
        const SmartphoneIcon = (props) => <Icon {...props} path={<><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></>} />;
        const UserIcon = (props) => <Icon {...props} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;

        // --- DATA ---
        const COURSES = {
            en: [
                { 
                id: 1, 
                title: "Level 1: Home Row Basics", 
                lessons: [
                    "aaaa ssss dddd ffff",
                    "jjjj kkkk llll ;;;;",
                    "asdf jkl; asdf jkl;",
                    "a s d f j k l ;",
                    "sad dad fad all fall",
                    "flask ask jak salad",
                    "adads jkll; fads",
                    "aaaa bbbb cccc dddd",
                    "aa ss dd ff jj kk ll ;;",
                    "dad has a salad"
                ]
                },
                { 
                id: 2, 
                title: "Level 2: Top & Bottom Rows", 
                lessons: [
                    "qqq www eee rrr ttt",
                    "yyy uuu iii ooo ppp",
                    "zzz xxx ccc vvv bbb",
                    "nnn mmm ,,, ...",
                    "qwerty uiop zxcvb",
                    "the quick brown fox",
                    "pack my box now",
                    "run for the zoo",
                    "very big zebra",
                    "new moon over water"
                ]
                },
                {
                id: 3, 
                title: "Level 3: Capital Letters & Sentences", 
                lessons: [
                    "Alice and Bob are friends.",
                    "The Sun rises in the East.",
                    "React is a JS library.",
                    "Hello World! How are you?",
                    "Monday Tuesday Wednesday",
                    "January February March",
                    "I love coding in React.",
                    "Keep Calm and Type On.",
                    "A Quick Brown Fox.",
                    "Practice makes perfect."
                ]
                },
                {
                id: 4,
                title: "Level 4: Numbers & Symbols",
                lessons: [
                    "12345 67890 123 456",
                    "!@#$ %^&* ()_+",
                    "Email: user@example.com",
                    "Price: $19.99 (20% off)",
                    "Calculation: 5 + 5 = 10",
                    "Date: 01/01/2024",
                    "#Coding #Life #React",
                    "Print('Hello World');",
                    "Warning: System Error!",
                    "100% Accuracy is the goal."
                ]
                }
            ],
            km: [
                { 
                id: 1, 
                title: "វគ្គទី ១៖ ព្យញ្ជនៈជួរកណ្តាល", 
                lessons: [
                    "កកក ខខខ ចចច ឆឆឆ",
                    "ដដដ ណណណ តតត ថថថ",
                    "កខចឆ ដណតថ",
                    "ក ខ ច ឆ ដ ណ ត ថ",
                    "កដ ចថ ខណ ឆត",
                    "កក ខខ ចច ឆឆ ដដ",
                    "ណណ តត ថថ",
                    "កខ ចឆ ដណ តថ",
                    "ថត ឆក ដច ខណ",
                    "កខចឆដណតថ"
                ]
                },
                { 
                id: 2, 
                title: "វគ្គទី ២៖ ស្រៈនិស្ស័យ និង វណ្ណយុត្តិ", 
                lessons: [
                    "ា ិ ី ឹ ឺ ុ ូ ួ",
                    "ើ ឿ ៀ េ ែ ៃ ោ ៅ",
                    "កា គី ជួ ដេ តៃ",
                    "ខុំ ចាំ ឆេះ តែ",
                    "សួស្តី ពី កម្ពុជា",
                    "។ ៗ ៖ « » ? !",
                    "ដើរ លេង ក្នុង ព្រៃ",
                    "ញាំ បាយ នៅ ផ្ទះ",
                    "១ ២ ៣ ៤ ៥",
                    "សាមគ្គី គឺ ជា កម្លាំង"
                ]
                },
                { 
                id: 3, 
                title: "វគ្គទី ៣៖ ជើងអក្សរ និង ប្រយោគ", 
                lessons: [
                    "ខ្ញុំ ស្រលាញ់ អ្នក",
                    "ខ្មែរ ខ្លាំង ក្លា",
                    "គ្រូ បង្រៀន សិស្ស",
                    "ស្ត្រី និង បុរស",
                    "វិទ្យាសាស្ត្រ និង បច្ចេកវិទ្យា",
                    "សន្តិភាព និង ការអភិវឌ្ឍ",
                    "ភ្នំពេញ ស្អាត ណាស់",
                    "អង្គរវត្ត ជា អច្ឆរិយ",
                    "ព្យាយាម គង់ បាន សម្រេច",
                    "រៀន ឲ្យ ចេះ មិនមែន រៀន ឲ្យ ចប់"
                ]
                },
                {
                id: 4,
                title: "វគ្គទី ៤៖ អត្ថបទខ្លីៗ",
                lessons: [
                    "នៅ ក្នុង ព្រៃ មាន សត្វ ច្រើន។",
                    "ការ អាន សៀវភៅ ជួយ បង្កើន ចំណេះដឹង។",
                    "សូម គោរព ច្បាប់ ចរាចរណ៍ ទាំងអស់ គ្នា។",
                    "សុខភាព គឺ ជា ទ្រព្យ ដ៏ មាន តម្លៃ។",
                    "តើ អ្នក ឈ្មោះ អ្វី? ខ្ញុំ ឈ្មោះ សុខ។",
                    "១ + ១ = ២; ២ x ២ = ៤",
                    "តម្លៃ $៥០.០០ (បញ្ចុះតម្លៃ ១០%)",
                    "អ៊ីមែល៖ contact@example.com",
                    "ហាម ជក់ បារី នៅ ទីនេះ!",
                    "រីករាយ ថ្ងៃ ចូល ឆ្នាំ ថ្មី ប្រពៃណី ជាតិ។"
                ]
                }
            ]
        };

        // --- REGISTRATION COMPONENT ---
        function RegistrationForm({ onRegister }) {
            const [formData, setFormData] = useState({
                fullName: '',
                gender: 'ប្រុស',
                skill: '',
                phone: ''
            });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [phoneError, setPhoneError] = useState('');

            const handleChange = (e) => {
                const { name, value } = e.target;

                // Phone Validation: Only allow numbers
                if (name === 'phone') {
                    // Remove any non-numeric characters
                    const numericValue = value.replace(/\D/g, '');
                    
                    // Clear error if user starts typing correctly
                    if (numericValue.length > 0) {
                        setPhoneError('');
                    }

                    setFormData({
                        ...formData,
                        [name]: numericValue
                    });
                } else {
                    setFormData({
                        ...formData,
                        [name]: value
                    });
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                setPhoneError('');
                
                // Validate fields
                if (!formData.fullName || !formData.skill || !formData.phone) {
                    alert('សូមបំពេញព័ត៌មានឱ្យបានគ្រប់គ្រាន់');
                    setIsSubmitting(false);
                    return;
                }

                // Strict Cambodia Phone Validation
                // Starts with 0, followed by 8 or 9 digits (Total 9-10 digits)
                const phoneRegex = /^0[1-9]\d{7,8}$/;

                if (!phoneRegex.test(formData.phone)) {
                    setPhoneError('សូមបញ្ចូលលេខទូរស័ព្ទឱ្យបានត្រឹមត្រូវ (ឧ. 012345678)');
                    setIsSubmitting(false);
                    return;
                }

                // Get or Create Device ID
                let deviceId = localStorage.getItem('mktyping-device-id');
                if (!deviceId) {
                    deviceId = crypto.randomUUID();
                    localStorage.setItem('mktyping-device-id', deviceId);
                }

                const userData = {
                    ...formData,
                    deviceId: deviceId,
                    createdAt: new Date().toISOString()
                };

                try {
                    // Save to Firebase
                    await set(ref(db, 'users/' + deviceId), userData);
                    
                    // Save to LocalStorage for quick access
                    localStorage.setItem('mktyping-user', JSON.stringify(userData));
                    
                    onRegister(userData);
                } catch (error) {
                    console.error("Error saving user data:", error);
                    alert("មានបញ្ហាក្នុងការចុះឈ្មោះ សូមព្យាយាមម្តងទៀត។");
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-300">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform scale-100 transition-all">
                        <div className="bg-blue-600 p-6 text-center">
                            <div className="inline-flex p-3 bg-white/20 rounded-full mb-3">
                                <UserIcon className="w-8 h-8 text-white" />
                            </div>
                            <h2 className="text-2xl font-bold text-white mb-1">រៀនកុំព្យូទ័រកម្រិតដំបូង</h2>
                            <p className="text-blue-100 text-sm">សូមបំពេញព័ត៌មានផ្ទាល់ខ្លួនដើម្បីចាប់ផ្តើម</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="p-8 flex flex-col gap-5">
                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-2">ឈ្មោះពេញ (ភាសាខ្មែរ)</label>
                                <input 
                                    type="text" 
                                    name="fullName"
                                    value={formData.fullName}
                                    onChange={handleChange}
                                    className="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition"
                                    placeholder="ឧ. សុខ សាន្ត"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-2">ភេទ</label>
                                <div className="flex gap-4">
                                    <label className="flex items-center gap-2 cursor-pointer p-3 rounded-lg border border-slate-200 flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition">
                                        <input 
                                            type="radio" 
                                            name="gender" 
                                            value="ប្រុស" 
                                            checked={formData.gender === 'ប្រុស'}
                                            onChange={handleChange}
                                            className="w-4 h-4 text-blue-600"
                                        />
                                        <span>ប្រុស</span>
                                    </label>
                                    <label className="flex items-center gap-2 cursor-pointer p-3 rounded-lg border border-slate-200 flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition">
                                        <input 
                                            type="radio" 
                                            name="gender" 
                                            value="ស្រី" 
                                            checked={formData.gender === 'ស្រី'}
                                            onChange={handleChange}
                                            className="w-4 h-4 text-blue-600"
                                        />
                                        <span>ស្រី</span>
                                    </label>
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-2">ជំនាញដែលកំពុងរៀន</label>
                                <input 
                                    type="text" 
                                    name="skill"
                                    value={formData.skill}
                                    onChange={handleChange}
                                    className="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition"
                                    placeholder="ឧ. ព័ត៌មានវិទ្យា"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-2">លេខទូរស័ព្ទ</label>
                                <input 
                                    type="tel" 
                                    name="phone"
                                    value={formData.phone}
                                    onChange={handleChange}
                                    className={`w-full px-4 py-3 rounded-lg border ${phoneError ? 'border-red-500 focus:border-red-500 focus:ring-red-200' : 'border-slate-300 focus:border-blue-500 focus:ring-blue-200'} focus:ring-2 outline-none transition`}
                                    placeholder="012 345 678"
                                    required
                                />
                                {phoneError && <p className="text-red-500 text-xs mt-1 ml-1">{phoneError}</p>}
                            </div>

                            <button 
                                type="submit" 
                                disabled={isSubmitting}
                                className="mt-2 w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition disabled:opacity-70 flex justify-center items-center gap-2"
                            >
                                {isSubmitting ? <div className="loader border-2 w-5 h-5 border-white border-t-transparent"></div> : 'ចុះឈ្មោះ និង ចាប់ផ្តើម'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- APP COMPONENT ---
        function App() {
            const [lang, setLang] = useState('en');
            const [isDesktop, setIsDesktop] = useState(true);
            const [user, setUser] = useState(null);
            const [loadingUser, setLoadingUser] = useState(true);
            
            // State for Level and Sub-Lesson
            const [levelIndex, setLevelIndex] = useState(0);
            const [subIndex, setSubIndex] = useState(0);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showCourseComplete, setShowCourseComplete] = useState(false);

            // Check User Registration Status on Mount
            useEffect(() => {
                const checkUserRegistration = async () => {
                    // 1. Check LocalStorage first (Fastest)
                    const localUser = localStorage.getItem('mktyping-user');
                    if (localUser) {
                        setUser(JSON.parse(localUser));
                        setLoadingUser(false);
                        return;
                    }

                    // 2. If not in local, check for Device ID
                    let deviceId = localStorage.getItem('mktyping-device-id');
                    
                    if (deviceId) {
                        try {
                            // 3. Check Firebase using Device ID
                            const snapshot = await get(child(ref(db), `users/${deviceId}`));
                            if (snapshot.exists()) {
                                const userData = snapshot.val();
                                setUser(userData);
                                // Sync back to local storage
                                localStorage.setItem('mktyping-user', JSON.stringify(userData));
                            }
                        } catch (error) {
                            console.error("Error checking user in DB:", error);
                        }
                    }
                    setLoadingUser(false);
                };

                checkUserRegistration();
            }, []);

            // --- PRESENCE SYSTEM (Online/Offline) ---
            useEffect(() => {
                if (user && user.deviceId) {
                    const connectedRef = ref(db, ".info/connected");
                    const userStatusDatabaseRef = ref(db, `users/${user.deviceId}/status`);

                    const unsubscribe = onValue(connectedRef, (snap) => {
                        if (snap.val() === true) {
                            // When connected
                            
                            // 1. Set to offline when disconnected (queued on server)
                            onDisconnect(userStatusDatabaseRef).set({
                                state: 'offline',
                                last_changed: serverTimestamp()
                            }).then(() => {
                                // 2. Set to online now
                                set(userStatusDatabaseRef, {
                                    state: 'online',
                                    last_changed: serverTimestamp()
                                });
                            });
                        }
                    });

                    return () => {
                        unsubscribe();
                    };
                }
            }, [user]);

            // Check screen size
            useEffect(() => {
                const checkScreenSize = () => {
                // 1024px is generally considered the breakpoint for Desktop/Laptop view
                setIsDesktop(window.innerWidth >= 1024);
                };

                checkScreenSize(); // Check on mount
                window.addEventListener('resize', checkScreenSize);
                return () => window.removeEventListener('resize', checkScreenSize);
            }, []);

            // Load progress on mount
            useEffect(() => {
                try {
                const saved = localStorage.getItem(`typing-progress-${lang}-v2`);
                if (saved) {
                    const { l, s } = JSON.parse(saved);
                    // Validate indices
                    if (COURSES[lang][l] && COURSES[lang][l].lessons[s]) {
                    setLevelIndex(l);
                    setSubIndex(s);
                    return;
                    }
                }
                } catch (e) {
                console.error("Error loading progress", e);
                }
                // Default fallback
                setLevelIndex(0);
                setSubIndex(0);
            }, [lang]);

            const [userInput, setUserInput] = useState('');
            const [startTime, setStartTime] = useState(null);
            const [isFinished, setIsFinished] = useState(false);
            const [isLevelComplete, setIsLevelComplete] = useState(false);
            
            const [wpm, setWpm] = useState(0);
            const [accuracy, setAccuracy] = useState(100);
            const [errorCount, setErrorCount] = useState(0);
            
            const inputRef = useRef(null);

            const currentCourse = COURSES[lang][levelIndex] || COURSES[lang][0];
            const targetText = currentCourse.lessons[subIndex] || "";

            // Reset Logic
            const resetLesson = () => {
                setUserInput('');
                setStartTime(null);
                setIsFinished(false);
                setIsLevelComplete(false);
                setShowCourseComplete(false);
                setWpm(0);
                setAccuracy(100);
                setErrorCount(0);
                
                // Slight delay to ensure element is enabled and rendered before focus
                setTimeout(() => {
                    if(inputRef.current) inputRef.current.focus();
                }, 10);
            };

            // Trigger reset when level or sub-lesson changes
            useEffect(() => {
                resetLesson();
            }, [levelIndex, subIndex, lang]);

            const toggleLanguage = () => {
                setLang(prev => prev === 'en' ? 'km' : 'en');
            };

            const saveProgress = (l, s) => {
                try {
                localStorage.setItem(`typing-progress-${lang}-v2`, JSON.stringify({ l, s }));
                } catch (error) {
                console.error("Failed to save progress", error);
                }
            };

            const handleNext = () => {
                // Explicitly reset finished state immediately to improve UI responsiveness
                setIsFinished(false);
                setUserInput('');

                const totalLessonsInLevel = currentCourse.lessons.length;
                
                if (subIndex + 1 < totalLessonsInLevel) {
                    // Next sub-lesson in same level
                    const nextSub = subIndex + 1;
                    setSubIndex(nextSub);
                    saveProgress(levelIndex, nextSub);
                } else {
                    // Level Complete
                    const nextLevel = levelIndex + 1;
                    if (nextLevel < COURSES[lang].length) {
                        setLevelIndex(nextLevel);
                        setSubIndex(0);
                        saveProgress(nextLevel, 0);
                    } else {
                        // Course Complete
                        setShowCourseComplete(true);
                        // We still save progress as the end of this level
                        saveProgress(levelIndex, subIndex); 
                    }
                }
            };

            const requestReset = () => {
                setShowResetConfirm(true);
            };

            const confirmReset = () => {
                setLevelIndex(0);
                setSubIndex(0);
                saveProgress(0, 0);
                resetLesson();
                setShowResetConfirm(false);
                setShowCourseComplete(false);
            };

            const handleAreaClick = () => {
                if(inputRef.current) inputRef.current.focus();
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Backspace') {
                e.preventDefault();
                }
            };

            const handleChange = (e) => {
                const value = e.target.value;
                
                if (value.length < userInput.length) return; // Prevent deletion

                if (!startTime && value.length === 1) {
                setStartTime(Date.now());
                }

                // Error Tracking
                const lastCharIndex = value.length - 1;
                let currentErrors = errorCount;
                if (value[lastCharIndex] !== targetText[lastCharIndex]) {
                currentErrors = errorCount + 1;
                setErrorCount(currentErrors);
                }

                // Stats Logic
                if (startTime) {
                const timeElapsedMin = (Date.now() - startTime) / 60000;
                const currentWpm = Math.round((value.length / 5) / (timeElapsedMin || 0.001)); 
                setWpm(currentWpm < 0 || currentWpm > 200 ? 0 : currentWpm);

                let correctChars = 0;
                for (let i = 0; i < value.length; i++) {
                    if (value[i] === targetText[i]) correctChars++;
                }
                const acc = Math.round((correctChars / value.length) * 100);
                setAccuracy(isNaN(acc) ? 100 : acc);
                }

                setUserInput(value);

                if (value.length >= targetText.length) {
                setIsFinished(true);
                // Check if this was the last lesson of the level
                if (subIndex + 1 === currentCourse.lessons.length) {
                    setIsLevelComplete(true);
                }
                }
            };

            const renderText = () => {
                return targetText.split('').map((char, index) => {
                let colorClass = "text-gray-300";
                let bgClass = "";
                let borderClass = "";
                let displayChar = char;

                if (char === " ") displayChar = "␣"; 
                
                if (index < userInput.length) {
                    if (userInput[index] === char) {
                    colorClass = "text-green-600 font-medium";
                    } else {
                    colorClass = "text-red-600 font-bold";
                    bgClass = "bg-red-200";
                    borderClass = "border-b-2 border-red-500";
                    }
                }

                const isCursor = index === userInput.length;

                return (
                    <span key={index} className={`relative inline-block ${colorClass} ${bgClass} ${borderClass} rounded-sm transition-colors duration-100 min-w-[0.5em] text-center`}>
                    {isCursor && (
                        <span className="absolute left-0 -top-1 w-0.5 h-full bg-blue-600 animate-pulse"></span>
                    )}
                    {char === " " ? <span className="opacity-30">_</span> : char}
                    </span>
                );
                });
            };

            // --- LOADING SCREEN ---
            if (loadingUser) {
                return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center">
                         <div className="loader border-4 border-blue-500 w-12 h-12"></div>
                    </div>
                );
            }

            // --- MOBILE / TABLET BLOCKING SCREEN ---
            // MOVED UP: Check for mobile device BEFORE checking for registration
            if (!isDesktop) {
                return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center font-sans">
                    <div className="bg-white p-10 rounded-3xl shadow-2xl max-w-md flex flex-col items-center gap-6 border border-slate-100">
                    <div className="p-6 bg-red-100 rounded-full animate-bounce">
                        <SmartphoneIcon className="w-16 h-16 text-red-500" />
                    </div>
                    <div>
                        <h2 className="text-2xl font-bold text-slate-800 mb-2 font-['Hanuman']">
                        មិនអនុញ្ញាតលើទូរស័ព្ទដៃ
                        </h2>
                        <h3 className="text-lg font-semibold text-slate-600 mb-4">
                        Device Not Supported
                        </h3>
                        <p className="text-slate-500 leading-relaxed font-['Hanuman']">
                        កម្មវិធីនេះត្រូវបានរចនាឡើងសម្រាប់តែការប្រើប្រាស់លើ <strong>កុំព្យូទ័រ (PC/Laptop)</strong> ប៉ុណ្ណោះ ដើម្បីធានាប្រសិទ្ធភាពនៃការហ្វឹកហាត់វាយអក្សរ។
                        </p>
                        <div className="w-full h-px bg-slate-100 my-4"></div>
                        <p className="text-slate-400 text-sm">
                        Please switch to a desktop or laptop computer to use this typing application.
                        </p>
                    </div>
                    <div className="flex items-center gap-2 text-blue-600 font-medium bg-blue-50 px-6 py-3 rounded-full">
                        <MonitorIcon className="w-5 h-5" />
                        <span>Use Computer Only</span>
                    </div>
                    </div>
                </div>
                );
            }

            // --- REGISTRATION CHECK ---
            if (!user) {
                return <RegistrationForm onRegister={(data) => setUser(data)} />;
            }

            const fontStyle = lang === 'km' ? "font-['Hanuman',_sans-serif] text-2xl md:text-3xl leading-loose" : "font-mono text-2xl md:text-3xl leading-relaxed";

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col font-sans text-slate-800">
                
                {/* Reset Confirmation Modal */}
                {showResetConfirm && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
                        <div className="flex flex-col items-center text-center gap-4">
                        <div className="p-3 bg-red-100 rounded-full">
                            <AlertTriangleIcon className="w-8 h-8 text-red-600" />
                        </div>
                        <div>
                            <h3 className="text-xl font-bold text-slate-800 mb-2">
                            {lang === 'km' ? "ចាប់ផ្តើមថ្មី?" : "Reset Progress?"}
                            </h3>
                            <p className="text-slate-600 text-sm">
                            {lang === 'km' 
                                ? "តើអ្នកពិតជាចង់លុបការសិក្សាកន្លងមក ហើយចាប់ផ្តើមពីវគ្គទី ១ វិញមែនទេ?" 
                                : "Are you sure you want to delete your progress and start over from Level 1?"}
                            </p>
                        </div>
                        <div className="flex gap-3 w-full mt-2">
                            <button 
                            onClick={() => setShowResetConfirm(false)}
                            className="flex-1 px-4 py-2.5 text-slate-600 font-medium hover:bg-slate-100 rounded-xl transition border border-slate-200"
                            >
                            {lang === 'km' ? "ទេ" : "Cancel"}
                            </button>
                            <button 
                            onClick={confirmReset}
                            className="flex-1 px-4 py-2.5 bg-red-600 text-white font-medium hover:bg-red-700 rounded-xl shadow-lg shadow-red-200 transition"
                            >
                            {lang === 'km' ? "យល់ព្រម" : "Yes, Reset"}
                            </button>
                        </div>
                        </div>
                    </div>
                    </div>
                )}

                {/* Header */}
                <header className="bg-white shadow-sm sticky top-0 z-10">
                    <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-2">
                        <div className="bg-blue-600 p-2 rounded-lg shadow-blue-200 shadow-sm">
                        <KeyboardIcon className="w-6 h-6 text-white" />
                        </div>
                        <div className="hidden md:block">
                        <h1 className="text-xl font-bold bg-gradient-to-r from-blue-700 to-blue-500 bg-clip-text text-transparent">
                            MKTyping
                        </h1>
                        </div>
                        {/* Show User Name */}
                        {user && (
                            <div className="ml-4 flex items-center gap-2 bg-slate-100 px-3 py-1 rounded-full border border-slate-200">
                                <UserIcon className="w-4 h-4 text-slate-500" />
                                <span className="text-sm font-medium text-slate-600">{user.fullName}</span>
                            </div>
                        )}
                    </div>

                    <div className="flex items-center gap-3">
                        <div className="flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100">
                        <BookOpenIcon className="w-4 h-4 text-blue-600" />
                        <span className="text-sm font-semibold text-blue-800">
                            {lang === 'km' ? `វគ្គទី ${currentCourse.id}` : `Level ${currentCourse.id}`}
                        </span>
                        <span className="text-slate-400">|</span>
                        <span className="text-xs font-medium text-slate-500">
                            {subIndex + 1} / {currentCourse.lessons.length}
                        </span>
                        </div>

                        <button 
                        onClick={toggleLanguage}
                        className="flex items-center gap-2 px-4 py-2 rounded-full hover:bg-slate-100 transition-colors border border-transparent hover:border-slate-200"
                        >
                        <GlobeIcon className="w-4 h-4 text-slate-600" />
                        <span className="font-medium text-sm hidden sm:inline">{lang === 'km' ? 'English' : 'ខ្មែរ'}</span>
                        </button>

                        <button
                        onClick={requestReset}
                        className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full transition"
                        title="Reset All Progress"
                        >
                        <RotateCcwIcon className="w-5 h-5" />
                        </button>
                    </div>
                    </div>
                </header>

                {/* Main Content */}
                <main className="flex-1 max-w-5xl mx-auto w-full p-6 flex flex-col gap-6">
                    
                    {/* Lesson Title & Instructions */}
                    <div className="flex flex-col gap-2">
                        <div className="flex items-center justify-between">
                        <h2 className={`text-xl font-bold text-slate-800 ${lang === 'km' ? 'font-serif' : ''}`}>
                            {currentCourse.title}
                        </h2>
                        {/* Level Progress Dots */}
                        <div className="hidden md:flex gap-1">
                            {currentCourse.lessons.map((_, idx) => (
                                <div 
                                key={idx} 
                                className={`h-2 w-2 rounded-full ${idx < subIndex ? 'bg-green-500' : idx === subIndex ? 'bg-blue-500' : 'bg-slate-200'}`}
                                />
                            ))}
                        </div>
                        </div>
                        
                        <div className="flex gap-4 text-sm text-slate-500 items-center">
                            <span>{lang === 'km' ? `មេរៀនទី ${subIndex + 1}` : `Lesson ${subIndex + 1}`}</span>
                            <span className="h-1 w-1 rounded-full bg-slate-300"></span>
                            <span className={`${lang === 'km' ? 'text-orange-600' : 'text-orange-600'} flex items-center gap-1`}>
                                <AlertCircleIcon className="w-3 h-3" />
                                {lang === 'km' ? "ហាមលុប! (No Backspace)" : "No Backspace Allowed"}
                            </span>
                        </div>
                    </div>

                    {/* Stats Bar */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <StatCard label="WPM" value={wpm} color="text-blue-600" icon={<RefreshCwIcon className="w-4 h-4 opacity-50"/>} />
                    <StatCard label={lang === 'km' ? "ត្រឹមត្រូវ" : "Accuracy"} value={accuracy + "%"} color={accuracy > 90 ? "text-green-600" : "text-yellow-600"} />
                    <StatCard label={lang === 'km' ? "កំហុស" : "Errors"} value={errorCount} color="text-red-500" icon={<XCircleIcon className="w-4 h-4 text-red-400"/>} />
                    
                    <div className="flex items-center justify-end gap-2">
                        <button onClick={resetLesson} className="h-12 w-12 flex items-center justify-center rounded-xl bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 transition shadow-sm" title="Restart">
                            <RefreshCwIcon className="w-5 h-5" />
                        </button>
                        <button 
                            onClick={handleNext} 
                            disabled={!isFinished} 
                            className={`h-12 px-6 rounded-xl text-white transition flex items-center gap-2 shadow-lg 
                            ${isFinished 
                                ? (isLevelComplete ? 'bg-green-600 hover:bg-green-700 shadow-green-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200') 
                                : 'bg-slate-300 cursor-not-allowed shadow-none'}`}
                        >
                            <span className="font-medium">
                            {isLevelComplete 
                                ? (lang === 'km' ? "ចប់វគ្គ (Next Level)" : "Next Level") 
                                : (lang === 'km' ? "បន្ទាប់ (Next)" : "Next")}
                            </span>
                            <ChevronRightIcon className="w-4 h-4" />
                        </button>
                    </div>
                    </div>

                    {/* Typing Area */}
                    <div 
                    // Key ensures component remounts fully on lesson change, clearing any stale state
                    key={`${currentCourse.id}-${subIndex}`}
                    className="relative bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden flex flex-col min-h-[350px]"
                    onClick={handleAreaClick}
                    >
                    {/* Progress Bar */}
                    <div className="h-1.5 bg-slate-100 w-full">
                        <div 
                        className={`h-full transition-all duration-300 ${isFinished ? 'bg-green-500' : 'bg-blue-500'}`}
                        style={{ width: `${(userInput.length / targetText.length) * 100}%` }}
                        ></div>
                    </div>

                    <div className="flex-1 p-8 md:p-12 flex items-center justify-center text-center cursor-text relative z-10">
                        {showCourseComplete ? (
                        <div className="text-center animate-in fade-in zoom-in duration-300 max-w-md mx-auto">
                            <div className="inline-block p-5 rounded-full bg-blue-100 mb-6">
                            <AwardIcon className="w-20 h-20 text-blue-600" />
                            </div>
                            <h2 className="text-3xl font-bold text-slate-800 mb-2">
                            {lang === 'km' ? "អបអរសាទរ! ចប់វគ្គសិក្សាហើយ!" : "All Courses Completed!"}
                            </h2>
                            <p className="text-slate-500 mb-8">
                            {lang === 'km' 
                                ? "អ្នកបានបញ្ចប់គ្រប់មេរៀនទាំងអស់។ អ្នកអាចហ្វឹកហាត់ម្តងទៀតដើម្បីបង្កើនល្បឿន។" 
                                : "You have finished all lessons. You can restart to improve your speed."}
                            </p>
                            <button 
                            onClick={requestReset}
                            className="px-8 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg shadow-blue-200 transition cursor-pointer relative z-20"
                            >
                            {lang === 'km' ? "ចាប់ផ្តើមពីដើមវិញ" : "Start Over"}
                            </button>
                        </div>
                        ) : isFinished ? (
                        <div className="text-center animate-in fade-in zoom-in duration-300 max-w-md mx-auto">
                            <div className={`inline-block p-5 rounded-full mb-6 ${isLevelComplete ? 'bg-yellow-100' : 'bg-green-100'}`}>
                            {isLevelComplete ? <AwardIcon className="w-16 h-16 text-yellow-600" /> : <CheckCircle2Icon className="w-16 h-16 text-green-600" />}
                            </div>
                            
                            <h2 className="text-3xl font-bold text-slate-800 mb-2">
                            {isLevelComplete 
                                ? (lang === 'km' ? "ឆ្លងវគ្គជោគជ័យ!" : "Level Complete!") 
                                : (lang === 'km' ? "ល្អណាស់!" : "Great Job!")}
                            </h2>
                            
                            <p className="text-slate-500 mb-8">
                            {isLevelComplete 
                                ? (lang === 'km' ? "អ្នកបានបញ្ចប់គ្រប់មេរៀនក្នុងវគ្គនេះ។" : "You finished all lessons in this level.")
                                : (lang === 'km' ? "ត្រៀមខ្លួនសម្រាប់មេរៀនបន្ទាប់។" : "Ready for the next text.")}
                            </p>

                            <div className="flex gap-4 justify-center mb-8 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <div className="text-center px-4 border-r border-slate-200">
                                <div className="text-2xl font-bold text-blue-600">{wpm}</div>
                                <div className="text-[10px] uppercase font-bold tracking-wider opacity-60">WPM</div>
                            </div>
                            <div className="text-center px-4">
                                <div className="text-2xl font-bold text-green-600">{accuracy}%</div>
                                <div className="text-[10px] uppercase font-bold tracking-wider opacity-60">Accuracy</div>
                            </div>
                            </div>

                            <button 
                            onClick={handleNext}
                            className={`w-full py-4 text-white rounded-xl font-bold shadow-lg transition transform hover:-translate-y-0.5 flex items-center justify-center gap-2 cursor-pointer relative z-20
                                ${isLevelComplete ? 'bg-green-600 hover:bg-green-700 shadow-green-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'}`}
                            >
                            {isLevelComplete 
                                ? (lang === 'km' ? "ចូលទៅកាន់វគ្គថ្មី" : "Start Next Level")
                                : (lang === 'km' ? "មេរៀនបន្ទាប់" : "Next Text")}
                            <ChevronRightIcon className="w-5 h-5" />
                            </button>
                        </div>
                        ) : (
                        <div className={`${fontStyle} tracking-wide select-none break-words w-full`}>
                            {renderText()}
                        </div>
                        )}
                    </div>

                    <textarea
                        ref={inputRef}
                        value={userInput}
                        onChange={handleChange}
                        onKeyDown={handleKeyDown}
                        className={`absolute opacity-0 top-0 left-0 w-full h-full cursor-default resize-none ${isFinished ? 'hidden' : 'block'}`}
                        autoFocus
                        autoComplete="off"
                        autoCorrect="off"
                        spellCheck="false"
                        disabled={isFinished}
                    />
                    </div>
                </main>
                </div>
            );
        }

        // --- STAT CARD COMPONENT ---
        function StatCard({ label, value, color, icon }) {
            return (
                <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col items-center justify-center relative overflow-hidden group">
                <div className="absolute top-2 right-2 opacity-50">{icon}</div>
                <span className="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">{label}</span>
                <span className={`text-3xl font-bold ${color}`}>{value}</span>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
