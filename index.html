<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKTyping</title>
    <link
      rel="icon"
      href="https://i.postimg.cc/vZKR0xtD/typing.png"
      type="image/jpeg"
    />
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Load Google Fonts: Hanuman for Khmer -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hanuman:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Hanuman', sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child, onDisconnect, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const { useState, useEffect, useRef, useMemo } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCClq3kieix1eDgZkxx-RnBIUG1spdQkHQ",
            authDomain: "mktyping-19d0a.firebaseapp.com",
            projectId: "mktyping-19d0a",
            storageBucket: "mktyping-19d0a.firebasestorage.app",
            messagingSenderId: "72913605220",
            appId: "1:72913605220:web:5a20fcd2762deda78a4571",
            measurementId: "G-H85KTXXB5P"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- ICONS COMPONENTS ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const KeyboardIcon = (props) => <Icon {...props} path={<><rect width="20" height="16" x="2" y="4" rx="2" ry="2"/><path d="M6 8h.001"/><path d="M10 8h.001"/><path d="M14 8h.001"/><path d="M18 8h.001"/><path d="M6 12h.001"/><path d="M10 12h.001"/><path d="M14 12h.001"/><path d="M18 12h.001"/><path d="M7 16h10"/></>} />;
        const GlobeIcon = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></>} />;
        const RefreshCwIcon = (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />;
        const AwardIcon = (props) => <Icon {...props} path={<><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></>} />;
        const AlertCircleIcon = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />;
        const ChevronRightIcon = (props) => <Icon {...props} path={<path d="m9 18 6-6-6-6"/>} />;
        const XCircleIcon = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>} />;
        const BookOpenIcon = (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />;
        const RotateCcwIcon = (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>} />;
        const CheckCircle2Icon = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>} />;
        const AlertTriangleIcon = (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>} />;
        const MonitorIcon = (props) => <Icon {...props} path={<><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></>} />;
        const SmartphoneIcon = (props) => <Icon {...props} path={<><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></>} />;
        const UserIcon = (props) => <Icon {...props} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
        const StarIcon = (props) => <Icon {...props} path={<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />} />;

        // --- COURSE DATA GENERATOR ---
        // Helper to create array of N items
        const generateLessons = (baseTexts, count) => {
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(baseTexts[i % baseTexts.length]);
            }
            return result;
        };

        // --- CONTENT DATA ---
        const EN_SHORT = ["asdf", "jkl;", "qwer", "uiop", "zxcv", "nm,.", "tygh", "bnmv", "asdf jkl;", "the quick"];
        const EN_LONG = [
            "The quick brown fox jumps over the lazy dog.",
            "Practice makes perfect in every skill you learn.",
            "React is a popular JavaScript library for building user interfaces.",
            "Consistency is key to mastering touch typing.",
            "Technology is changing the world at a rapid pace.",
            "Coding is the new literacy in the digital age.",
            "Learning to type fast saves you hundreds of hours.",
            "Success is not final, failure is not fatal: it is the courage to continue that counts.",
            "Believe you can and you're halfway there.",
            "Do what you can, with what you have, where you are.",
            "The only way to do great work is to love what you do.",
            "In the middle of every difficulty lies opportunity.",
            "Happiness is not something ready made. It comes from your own actions.",
            "It always seems impossible until it is done.",
            "Dream big and dare to fail."
        ];

        const KM_SHORT = ["កកក", "ខខខ", "ចចច", "ឆឆឆ", "ដដដ", "ណណណ", "តតត", "ថថថ", "កខចឆ", "ដណតថ"];
        const KM_LONG = [
            "ខ្ញុំស្រឡាញ់ប្រទេសកម្ពុជាដែលមានប្រាសាទអង្គរវត្តជាសម្បត្តិបេតិកភណ្ឌពិភពលោក។",
            "ការសិក្សាគឺជាគន្លឹះនៃភាពជោគជ័យក្នុងជីវិតនិងអនាគត។",
            "សាមគ្គីភាពនាំមកនូវសន្តិភាពនិងការរីកចម្រើនដល់សង្គមជាតិ។",
            "រាជធានីភ្នំពេញគឺជាបេះដូងនៃព្រះរាជាណាចក្រកម្ពុជា។",
            "ព្យាយាមគង់បានសម្រេច ដូចពាក្យចាស់ពោលថា គង់មានថ្ងៃជោគជ័យ។",
            "សុខភាពគឺជាទ្រព្យសម្បត្តិដ៏មានតម្លៃបំផុតសម្រាប់មនុស្សគ្រប់រូប។",
            "ការគោរពចាស់ទុំគឺជាប្រពៃណីដ៏ល្អផូរផង់របស់ប្រជាជនខ្មែរ។",
            "សូមចូលរួមការពារបរិស្ថានដើម្បីផែនដីរបស់យើងទាំងអស់គ្នា។",
            "បច្ចេកវិទ្យាព័ត៌មានកំពុងអភិវឌ្ឍយ៉ាងខ្លាំងក្លានៅក្នុងយុគសម័យនេះ។",
            "ការអានសៀវភៅជួយពង្រីកចំណេះដឹងនិងបង្កើនសមត្ថភាពគិត។",
            "ទេសចរណ៍គឺជាមាសបៃតងដែលជួយទ្រទ្រង់សេដ្ឋកិច្ចជាតិ។",
            "ញញឹមស្វាគមន៍ភ្ញៀវទេសចរណ៍ដែលមកទស្សនាប្រទេសយើង។",
            "កីឡានាំមកនូវសុខភាព មិត្តភាព និងសាមគ្គីភាព។",
            "ស្រឡាញ់ជាតិ ត្រូវហ៊ានលះបង់ដើម្បីបុព្វហេតុជាតិ។",
            "ធ្វើល្អបានល្អ ធ្វើអាក្រក់បានអាក្រក់ គឺជាច្បាប់ធម្មជាតិ។"
        ];

        const COURSES = {
            en: [
                { id: 1, title: "Level 1: Home Row", lessons: generateLessons(["asdf", "jkl;", "sad", "dad", "fad", "all", "fall", "ask", "add", "flask"], 10) },
                { id: 2, title: "Level 2: Top Row", lessons: generateLessons(["qwer", "tyui", "op", "pot", "top", "tree", "were", "quit", "rope", "power"], 10) },
                { id: 3, title: "Level 3: Bottom Row", lessons: generateLessons(["zxcv", "bnm", "zap", "cab", "van", "man", "ban", "zone", "come", "name"], 10) },
                { id: 4, title: "Level 4: Numbers", lessons: generateLessons(["123", "456", "789", "0", "10", "2024", "100%", "5+5", "1999", "12345"], 10) },
                // Levels 5-9: 15 Long texts
                { id: 5, title: "Level 5: Basic Sentences", lessons: generateLessons(EN_LONG.slice(0, 5), 15) },
                { id: 6, title: "Level 6: Capitalization", lessons: generateLessons(EN_LONG.slice(5, 10), 15) },
                { id: 7, title: "Level 7: Punctuation", lessons: generateLessons(EN_LONG.slice(10, 15), 15) },
                { id: 8, title: "Level 8: Advanced Typing", lessons: generateLessons([...EN_LONG].reverse(), 15) },
                { id: 9, title: "Level 9: Mastery", lessons: generateLessons([...EN_LONG, ...EN_LONG], 15) }
            ],
            km: [
                { id: 1, title: "វគ្គទី ១៖ ជួរកណ្តាល", lessons: generateLessons(["កកក", "ខខខ", "ចចច", "ឆឆឆ", "ដដដ", "ណណណ", "តតត", "ថថថ", "កខចឆ", "ដណតថ"], 10) },
                { id: 2, title: "វគ្គទី ២៖ ជួរលើ", lessons: generateLessons(["ងងង", "រររ", "ញញញ", "ភភភ", "ទទទ", "ធធធ", "យយយ", "សសស", "ហហហ", "អអអ"], 10) },
                { id: 3, title: "វគ្គទី ៣៖ ជួរក្រោម", lessons: generateLessons(["វវវ", "បបប", "ននន", "មមម", "៊៊៊", "ិិិ", "ីីី", "ឹឹឹ", "ឺឺឺ", "ុុុ"], 10) },
                { id: 4, title: "វគ្គទី ៤៖ លេខខ្មែរ", lessons: generateLessons(["១២៣", "៤៥៦", "៧៨៩", "០", "១០", "២០២៤", "១០០", "៥+៥", "១៩៩៩", "១២៣៤៥"], 10) },
                // Levels 5-9: 15 Long texts
                { id: 5, title: "វគ្គទី ៥៖ ប្រយោគមូលដ្ឋាន", lessons: generateLessons(KM_LONG.slice(0, 5), 15) },
                { id: 6, title: "វគ្គទី ៦៖ ស្រៈនិស្ស័យ", lessons: generateLessons(KM_LONG.slice(5, 10), 15) },
                { id: 7, title: "វគ្គទី ៧៖ វណ្ណយុត្តិ", lessons: generateLessons(KM_LONG.slice(10, 15), 15) },
                { id: 8, title: "វគ្គទី ៨៖ អត្ថបទកម្រិតខ្ពស់", lessons: generateLessons([...KM_LONG].reverse(), 15) },
                { id: 9, title: "វគ្គទី ៩៖ កំពូលអ្នកវាយ", lessons: generateLessons([...KM_LONG, ...KM_LONG], 15) }
            ]
        };

        // --- REGISTRATION COMPONENT ---
        function RegistrationForm({ onRegister }) {
            const [formData, setFormData] = useState({
                fullName: '',
                gender: 'ប្រុស',
                skill: '',
                phone: ''
            });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [phoneError, setPhoneError] = useState('');

            const handleChange = (e) => {
                const { name, value } = e.target;
                if (name === 'phone') {
                    const numericValue = value.replace(/\D/g, '');
                    if (numericValue.length > 0) setPhoneError('');
                    setFormData({ ...formData, [name]: numericValue });
                } else {
                    setFormData({ ...formData, [name]: value });
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                setPhoneError('');
                
                if (!formData.fullName || !formData.skill || !formData.phone) {
                    alert('សូមបំពេញព័ត៌មានឱ្យបានគ្រប់គ្រាន់');
                    setIsSubmitting(false);
                    return;
                }

                const phoneRegex = /^0[1-9]\d{7,8}$/;
                if (!phoneRegex.test(formData.phone)) {
                    setPhoneError('សូមបញ្ចូលលេខទូរស័ព្ទឱ្យបានត្រឹមត្រូវ (ឧ. 012345678)');
                    setIsSubmitting(false);
                    return;
                }

                let deviceId = localStorage.getItem('mktyping-device-id');
                if (!deviceId) {
                    deviceId = crypto.randomUUID();
                    localStorage.setItem('mktyping-device-id', deviceId);
                }

                const userData = {
                    ...formData,
                    deviceId: deviceId,
                    createdAt: new Date().toISOString()
                };

                try {
                    await set(ref(db, 'users/' + deviceId), userData);
                    localStorage.setItem('mktyping-user', JSON.stringify(userData));
                    onRegister(userData);
                } catch (error) {
                    console.error("Error saving user data:", error);
                    alert("មានបញ្ហាក្នុងការចុះឈ្មោះ សូមព្យាយាមម្តងទៀត។");
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-300">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform scale-100 transition-all">
                        <div className="bg-blue-600 p-6 text-center">
                            <div className="inline-flex p-3 bg-white/20 rounded-full mb-3">
                                <UserIcon className="w-8 h-8 text-white" />
                            </div>
                            <h2 className="text-2xl font-bold text-white mb-1">រៀនកុំព្យូទ័រកម្រិតដំបូង</h2>
                            <p className="text-blue-100 text-sm">សូមបំពេញព័ត៌មានផ្ទាល់ខ្លួនដើម្បីចាប់ផ្តើម</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="p-8 flex flex-col gap-5">
                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-2">ឈ្មោះពេញ (ភាសាខ្មែរ)</label>
                                <input type="text" name="fullName" value={formData.fullName} onChange={handleChange} className="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition" placeholder="ឧ. សុខ សាន្ត" required />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-2">ភេទ</label>
                                <div className="flex gap-4">
                                    <label className="flex items-center gap-2 cursor-pointer p-3 rounded-lg border border-slate-200 flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition">
                                        <input type="radio" name="gender" value="ប្រុស" checked={formData.gender === 'ប្រុស'} onChange={handleChange} className="w-4 h-4 text-blue-600" />
                                        <span>ប្រុស</span>
                                    </label>
                                    <label className="flex items-center gap-2 cursor-pointer p-3 rounded-lg border border-slate-200 flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition">
                                        <input type="radio" name="gender" value="ស្រី" checked={formData.gender === 'ស្រី'} onChange={handleChange} className="w-4 h-4 text-blue-600" />
                                        <span>ស្រី</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-2">ជំនាញដែលកំពុងរៀន</label>
                                <input type="text" name="skill" value={formData.skill} onChange={handleChange} className="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition" placeholder="ឧ. ព័ត៌មានវិទ្យា" required />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-2">លេខទូរស័ព្ទ</label>
                                <input type="tel" name="phone" value={formData.phone} onChange={handleChange} className={`w-full px-4 py-3 rounded-lg border ${phoneError ? 'border-red-500 focus:border-red-500 focus:ring-red-200' : 'border-slate-300 focus:border-blue-500 focus:ring-blue-200'} focus:ring-2 outline-none transition`} placeholder="012 345 678" required />
                                {phoneError && <p className="text-red-500 text-xs mt-1 ml-1">{phoneError}</p>}
                            </div>
                            <button type="submit" disabled={isSubmitting} className="mt-2 w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition disabled:opacity-70 flex justify-center items-center gap-2">
                                {isSubmitting ? <div className="loader border-2 w-5 h-5 border-white border-t-transparent"></div> : 'ចុះឈ្មោះ និង ចាប់ផ្តើម'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- FINAL SUMMARY COMPONENT ---
        function CourseSummary({ history, onRestart }) {
            const avgWpm = Math.round(history.reduce((acc, curr) => acc + curr.wpm, 0) / history.length) || 0;
            const avgAcc = Math.round(history.reduce((acc, curr) => acc + curr.accuracy, 0) / history.length) || 0;

            return (
                <div className="text-center animate-in fade-in zoom-in duration-500 w-full max-w-2xl mx-auto">
                    <div className="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
                        <div className="bg-blue-600 p-8 text-white">
                            <div className="inline-block p-4 bg-white/20 rounded-full mb-4 backdrop-blur-sm">
                                <AwardIcon className="w-16 h-16 text-yellow-300" />
                            </div>
                            <h2 className="text-3xl font-bold mb-2">អបអរសាទរ! អ្នកបានបញ្ចប់គ្រប់វគ្គហើយ</h2>
                            <p className="opacity-90">ខាងក្រោមនេះគឺជាលទ្ធផលសរុបរបស់អ្នក</p>
                        </div>
                        
                        <div className="p-8">
                            <div className="flex justify-center gap-8 mb-8">
                                <div className="text-center">
                                    <div className="text-4xl font-bold text-blue-600 mb-1">{avgWpm}</div>
                                    <div className="text-xs uppercase font-bold text-slate-400 tracking-wider">Average WPM</div>
                                </div>
                                <div className="w-px bg-slate-200"></div>
                                <div className="text-center">
                                    <div className="text-4xl font-bold text-green-600 mb-1">{avgAcc}%</div>
                                    <div className="text-xs uppercase font-bold text-slate-400 tracking-wider">Average Accuracy</div>
                                </div>
                            </div>

                            <div className="bg-slate-50 rounded-xl border border-slate-100 overflow-hidden mb-8">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-100 text-slate-600 font-bold">
                                            <tr>
                                                <th className="px-4 py-3">វគ្គ (Level)</th>
                                                <th className="px-4 py-3 text-center">ល្បឿន (WPM)</th>
                                                <th className="px-4 py-3 text-center">ត្រឹមត្រូវ (Accuracy)</th>
                                                <th className="px-4 py-3 text-center">ពិន្ទុ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {history.map((item, index) => (
                                                <tr key={index} className="hover:bg-white transition">
                                                    <td className="px-4 py-3 font-medium text-slate-700">{item.title}</td>
                                                    <td className="px-4 py-3 text-center text-blue-600 font-bold">{item.wpm}</td>
                                                    <td className="px-4 py-3 text-center text-green-600 font-bold">{item.accuracy}%</td>
                                                    <td className="px-4 py-3 text-center">
                                                        <div className="flex justify-center">
                                                            {[...Array(item.accuracy >= 90 ? 3 : item.accuracy >= 80 ? 2 : 1)].map((_, i) => (
                                                                <StarIcon key={i} className="w-4 h-4 text-yellow-400 fill-yellow-400" />
                                                            ))}
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <button 
                                onClick={onRestart}
                                className="w-full py-4 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition transform hover:-translate-y-0.5 flex items-center justify-center gap-2"
                            >
                                <RotateCcwIcon className="w-5 h-5" />
                                ចាប់ផ្តើមរៀនសារជាថ្មី
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- APP COMPONENT ---
        function App() {
            const [lang, setLang] = useState('en');
            const [isDesktop, setIsDesktop] = useState(true);
            const [user, setUser] = useState(null);
            const [loadingUser, setLoadingUser] = useState(true);
            
            // State for Level and Sub-Lesson
            const [levelIndex, setLevelIndex] = useState(0);
            const [subIndex, setSubIndex] = useState(0);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showCourseComplete, setShowCourseComplete] = useState(false);
            const [history, setHistory] = useState([]); // To store results of each level

            // Check User Registration Status on Mount
            useEffect(() => {
                const checkUserRegistration = async () => {
                    const localUser = localStorage.getItem('mktyping-user');
                    if (localUser) {
                        setUser(JSON.parse(localUser));
                        setLoadingUser(false);
                        return;
                    }
                    let deviceId = localStorage.getItem('mktyping-device-id');
                    if (deviceId) {
                        try {
                            const snapshot = await get(child(ref(db), `users/${deviceId}`));
                            if (snapshot.exists()) {
                                const userData = snapshot.val();
                                setUser(userData);
                                localStorage.setItem('mktyping-user', JSON.stringify(userData));
                            }
                        } catch (error) {
                            console.error("Error checking user in DB:", error);
                        }
                    }
                    setLoadingUser(false);
                };
                checkUserRegistration();
            }, []);

            // Presence System
            useEffect(() => {
                if (user && user.deviceId) {
                    const connectedRef = ref(db, ".info/connected");
                    const userStatusDatabaseRef = ref(db, `users/${user.deviceId}/status`);
                    const unsubscribe = onValue(connectedRef, (snap) => {
                        if (snap.val() === true) {
                            onDisconnect(userStatusDatabaseRef).set({
                                state: 'offline',
                                last_changed: serverTimestamp()
                            }).then(() => {
                                set(userStatusDatabaseRef, {
                                    state: 'online',
                                    last_changed: serverTimestamp()
                                });
                            });
                        }
                    });
                    return () => unsubscribe();
                }
            }, [user]);

            // Check screen size
            useEffect(() => {
                const checkScreenSize = () => {
                    setIsDesktop(window.innerWidth >= 1024);
                };
                checkScreenSize();
                window.addEventListener('resize', checkScreenSize);
                return () => window.removeEventListener('resize', checkScreenSize);
            }, []);

            // Load progress and history
            useEffect(() => {
                try {
                    const saved = localStorage.getItem(`typing-progress-${lang}-v3`); // Changed key to v3 for new structure
                    if (saved) {
                        const { l, s, h } = JSON.parse(saved);
                        if (COURSES[lang][l] && COURSES[lang][l].lessons[s]) {
                            setLevelIndex(l);
                            setSubIndex(s);
                            if (h) setHistory(h);
                            return;
                        }
                    }
                } catch (e) {
                    console.error("Error loading progress", e);
                }
                setLevelIndex(0);
                setSubIndex(0);
                setHistory([]);
            }, [lang]);

            const [userInput, setUserInput] = useState('');
            const [startTime, setStartTime] = useState(null);
            const [isFinished, setIsFinished] = useState(false);
            const [isLevelComplete, setIsLevelComplete] = useState(false);
            
            const [wpm, setWpm] = useState(0);
            const [accuracy, setAccuracy] = useState(100);
            const [errorCount, setErrorCount] = useState(0);
            
            const inputRef = useRef(null);

            const currentCourse = COURSES[lang][levelIndex] || COURSES[lang][0];
            const targetText = currentCourse.lessons[subIndex] || "";

            const resetLesson = () => {
                setUserInput('');
                setStartTime(null);
                setIsFinished(false);
                setIsLevelComplete(false);
                setShowCourseComplete(false);
                setWpm(0);
                setAccuracy(100);
                setErrorCount(0);
                setTimeout(() => {
                    if(inputRef.current) inputRef.current.focus();
                }, 10);
            };

            useEffect(() => {
                resetLesson();
            }, [levelIndex, subIndex, lang]);

            const toggleLanguage = () => {
                setLang(prev => prev === 'en' ? 'km' : 'en');
            };

            const saveProgress = (l, s, h) => {
                try {
                    localStorage.setItem(`typing-progress-${lang}-v3`, JSON.stringify({ l, s, h }));
                } catch (error) {
                    console.error("Failed to save progress", error);
                }
            };

            const handleNext = () => {
                setIsFinished(false);
                setUserInput('');

                const totalLessonsInLevel = currentCourse.lessons.length;
                
                if (subIndex + 1 < totalLessonsInLevel) {
                    const nextSub = subIndex + 1;
                    setSubIndex(nextSub);
                    saveProgress(levelIndex, nextSub, history);
                } else {
                    // Level Complete: Record stats
                    const levelResult = {
                        level: currentCourse.id,
                        title: currentCourse.title,
                        wpm: wpm,
                        accuracy: accuracy
                    };
                    const newHistory = [...history, levelResult];
                    setHistory(newHistory);

                    const nextLevel = levelIndex + 1;
                    if (nextLevel < COURSES[lang].length) {
                        setLevelIndex(nextLevel);
                        setSubIndex(0);
                        saveProgress(nextLevel, 0, newHistory);
                    } else {
                        setShowCourseComplete(true);
                        saveProgress(levelIndex, subIndex, newHistory);
                    }
                }
            };

            const requestReset = () => {
                setShowResetConfirm(true);
            };

            const confirmReset = () => {
                setLevelIndex(0);
                setSubIndex(0);
                setHistory([]);
                saveProgress(0, 0, []);
                resetLesson();
                setShowResetConfirm(false);
                setShowCourseComplete(false);
            };

            const handleAreaClick = () => {
                if(inputRef.current) inputRef.current.focus();
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Backspace') {
                    e.preventDefault();
                }
            };

            const handleChange = (e) => {
                const value = e.target.value;
                if (value.length < userInput.length) return;
                if (!startTime && value.length === 1) setStartTime(Date.now());

                const lastCharIndex = value.length - 1;
                let currentErrors = errorCount;
                if (value[lastCharIndex] !== targetText[lastCharIndex]) {
                    currentErrors = errorCount + 1;
                    setErrorCount(currentErrors);
                }

                if (startTime) {
                    const timeElapsedMin = (Date.now() - startTime) / 60000;
                    const currentWpm = Math.round((value.length / 5) / (timeElapsedMin || 0.001)); 
                    setWpm(currentWpm < 0 || currentWpm > 200 ? 0 : currentWpm);

                    let correctChars = 0;
                    for (let i = 0; i < value.length; i++) {
                        if (value[i] === targetText[i]) correctChars++;
                    }
                    const acc = Math.round((correctChars / value.length) * 100);
                    setAccuracy(isNaN(acc) ? 100 : acc);
                }

                setUserInput(value);

                if (value.length >= targetText.length) {
                    setIsFinished(true);
                    if (subIndex + 1 === currentCourse.lessons.length) {
                        setIsLevelComplete(true);
                    }
                }
            };

            const renderText = () => {
                return targetText.split('').map((char, index) => {
                    let colorClass = "text-gray-300";
                    let bgClass = "";
                    let borderClass = "";
                    
                    if (index < userInput.length) {
                        if (userInput[index] === char) {
                            colorClass = "text-green-600 font-medium";
                        } else {
                            colorClass = "text-red-600 font-bold";
                            bgClass = "bg-red-200";
                            borderClass = "border-b-2 border-red-500";
                        }
                    }

                    const isCursor = index === userInput.length;

                    return (
                        <span key={index} className={`relative inline-block ${colorClass} ${bgClass} ${borderClass} rounded-sm transition-colors duration-100 min-w-[0.6em] text-center whitespace-pre`}>
                            {isCursor && <span className="absolute left-0 -top-1 w-0.5 h-full bg-blue-600 animate-pulse"></span>}
                            {char}
                        </span>
                    );
                });
            };

            if (loadingUser) {
                return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center">
                         <div className="loader border-4 border-blue-500 w-12 h-12"></div>
                    </div>
                );
            }

            if (!isDesktop) {
                return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center font-sans">
                    <div className="bg-white p-10 rounded-3xl shadow-2xl max-w-md flex flex-col items-center gap-6 border border-slate-100">
                    <div className="p-6 bg-red-100 rounded-full animate-bounce">
                        <SmartphoneIcon className="w-16 h-16 text-red-500" />
                    </div>
                    <div>
                        <h2 className="text-2xl font-bold text-slate-800 mb-2 font-['Hanuman']">
                        មិនអនុញ្ញាតលើទូរស័ព្ទដៃ
                        </h2>
                        <h3 className="text-lg font-semibold text-slate-600 mb-4">
                        Device Not Supported
                        </h3>
                        <p className="text-slate-500 leading-relaxed font-['Hanuman']">
                        កម្មវិធីនេះត្រូវបានរចនាឡើងសម្រាប់តែការប្រើប្រាស់លើ <strong>កុំព្យូទ័រ (PC/Laptop)</strong> ប៉ុណ្ណោះ ដើម្បីធានាប្រសិទ្ធភាពនៃការហ្វឹកហាត់វាយអក្សរ។
                        </p>
                    </div>
                    <div className="flex items-center gap-2 text-blue-600 font-medium bg-blue-50 px-6 py-3 rounded-full">
                        <MonitorIcon className="w-5 h-5" />
                        <span>Use Computer Only</span>
                    </div>
                    </div>
                </div>
                );
            }

            if (!user) {
                return <RegistrationForm onRegister={(data) => setUser(data)} />;
            }

            const fontStyle = lang === 'km' ? "font-['Hanuman',_sans-serif] text-2xl md:text-3xl leading-loose" : "font-mono text-2xl md:text-3xl leading-relaxed";

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col font-sans text-slate-800">
                
                {/* Reset Confirmation Modal */}
                {showResetConfirm && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
                        <div className="flex flex-col items-center text-center gap-4">
                        <div className="p-3 bg-red-100 rounded-full">
                            <AlertTriangleIcon className="w-8 h-8 text-red-600" />
                        </div>
                        <div>
                            <h3 className="text-xl font-bold text-slate-800 mb-2">
                            {lang === 'km' ? "ចាប់ផ្តើមថ្មី?" : "Reset Progress?"}
                            </h3>
                            <p className="text-slate-600 text-sm">
                            {lang === 'km' 
                                ? "តើអ្នកពិតជាចង់លុបការសិក្សាកន្លងមក ហើយចាប់ផ្តើមពីវគ្គទី ១ វិញមែនទេ?" 
                                : "Are you sure you want to delete your progress and start over from Level 1?"}
                            </p>
                        </div>
                        <div className="flex gap-3 w-full mt-2">
                            <button onClick={() => setShowResetConfirm(false)} className="flex-1 px-4 py-2.5 text-slate-600 font-medium hover:bg-slate-100 rounded-xl transition border border-slate-200">{lang === 'km' ? "ទេ" : "Cancel"}</button>
                            <button onClick={confirmReset} className="flex-1 px-4 py-2.5 bg-red-600 text-white font-medium hover:bg-red-700 rounded-xl shadow-lg shadow-red-200 transition">{lang === 'km' ? "យល់ព្រម" : "Yes, Reset"}</button>
                        </div>
                        </div>
                    </div>
                    </div>
                )}

                {/* Header */}
                <header className="bg-white shadow-sm sticky top-0 z-10">
                    <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-2">
                        <div className="bg-blue-600 p-2 rounded-lg shadow-blue-200 shadow-sm">
                        <KeyboardIcon className="w-6 h-6 text-white" />
                        </div>
                        <div className="hidden md:block">
                        <h1 className="text-xl font-bold bg-gradient-to-r from-blue-700 to-blue-500 bg-clip-text text-transparent">MKTyping</h1>
                        </div>
                        {user && (
                            <div className="ml-4 flex items-center gap-2 bg-slate-100 px-3 py-1 rounded-full border border-slate-200">
                                <UserIcon className="w-4 h-4 text-slate-500" />
                                <span className="text-sm font-medium text-slate-600">{user.fullName}</span>
                            </div>
                        )}
                    </div>

                    <div className="flex items-center gap-3">
                        <div className="flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100">
                        <BookOpenIcon className="w-4 h-4 text-blue-600" />
                        <span className="text-sm font-semibold text-blue-800">
                            {lang === 'km' ? `វគ្គទី ${currentCourse.id}` : `Level ${currentCourse.id}`}
                        </span>
                        <span className="text-slate-400">|</span>
                        <span className="text-xs font-medium text-slate-500">
                            {subIndex + 1} / {currentCourse.lessons.length}
                        </span>
                        </div>

                        <button onClick={toggleLanguage} className="flex items-center gap-2 px-4 py-2 rounded-full hover:bg-slate-100 transition-colors border border-transparent hover:border-slate-200">
                        <GlobeIcon className="w-4 h-4 text-slate-600" />
                        <span className="font-medium text-sm hidden sm:inline">{lang === 'km' ? 'English' : 'ខ្មែរ'}</span>
                        </button>

                        <button onClick={requestReset} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full transition" title="Reset All Progress">
                        <RotateCcwIcon className="w-5 h-5" />
                        </button>
                    </div>
                    </div>
                </header>

                {/* Main Content */}
                <main className="flex-1 max-w-5xl mx-auto w-full p-6 flex flex-col gap-6">
                    
                    {/* Lesson Title & Instructions */}
                    <div className="flex flex-col gap-2">
                        <div className="flex items-center justify-between">
                        <h2 className={`text-xl font-bold text-slate-800 ${lang === 'km' ? 'font-serif' : ''}`}>
                            {currentCourse.title}
                        </h2>
                        {/* Level Progress Dots (Only show a few or handle overflow if too many lessons) */}
                        <div className="hidden md:flex gap-1">
                            {currentCourse.lessons.map((_, idx) => (
                                <div key={idx} className={`h-2 w-2 rounded-full ${idx < subIndex ? 'bg-green-500' : idx === subIndex ? 'bg-blue-500' : 'bg-slate-200'}`} />
                            ))}
                        </div>
                        </div>
                        <div className="flex gap-4 text-sm text-slate-500 items-center">
                            <span>{lang === 'km' ? `មេរៀនទី ${subIndex + 1}` : `Lesson ${subIndex + 1}`}</span>
                            <span className="h-1 w-1 rounded-full bg-slate-300"></span>
                            <span className={`${lang === 'km' ? 'text-orange-600' : 'text-orange-600'} flex items-center gap-1`}>
                                <AlertCircleIcon className="w-3 h-3" />
                                {lang === 'km' ? "ហាមលុប! (No Backspace)" : "No Backspace Allowed"}
                            </span>
                        </div>
                    </div>

                    {/* Stats Bar */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <StatCard label="WPM" value={wpm} color="text-blue-600" icon={<RefreshCwIcon className="w-4 h-4 opacity-50"/>} />
                    <StatCard label={lang === 'km' ? "ត្រឹមត្រូវ" : "Accuracy"} value={accuracy + "%"} color={accuracy > 90 ? "text-green-600" : "text-yellow-600"} />
                    <StatCard label={lang === 'km' ? "កំហុស" : "Errors"} value={errorCount} color="text-red-500" icon={<XCircleIcon className="w-4 h-4 text-red-400"/>} />
                    
                    <div className="flex items-center justify-end gap-2">
                        <button onClick={resetLesson} className="h-12 w-12 flex items-center justify-center rounded-xl bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 transition shadow-sm" title="Restart">
                            <RefreshCwIcon className="w-5 h-5" />
                        </button>
                        <button 
                            onClick={handleNext} 
                            disabled={!isFinished} 
                            className={`h-12 px-6 rounded-xl text-white transition flex items-center gap-2 shadow-lg 
                            ${isFinished 
                                ? (isLevelComplete ? 'bg-green-600 hover:bg-green-700 shadow-green-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200') 
                                : 'bg-slate-300 cursor-not-allowed shadow-none'}`}
                        >
                            <span className="font-medium">
                            {isLevelComplete 
                                ? (lang === 'km' ? "ចប់វគ្គ (Next Level)" : "Next Level") 
                                : (lang === 'km' ? "បន្ទាប់ (Next)" : "Next")}
                            </span>
                            <ChevronRightIcon className="w-4 h-4" />
                        </button>
                    </div>
                    </div>

                    {/* Typing Area */}
                    <div key={`${currentCourse.id}-${subIndex}`} className="relative bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden flex flex-col min-h-[350px]" onClick={handleAreaClick}>
                    <div className="h-1.5 bg-slate-100 w-full">
                        <div className={`h-full transition-all duration-300 ${isFinished ? 'bg-green-500' : 'bg-blue-500'}`} style={{ width: `${(userInput.length / targetText.length) * 100}%` }}></div>
                    </div>

                    <div className="flex-1 p-8 md:p-12 flex items-center justify-center text-center cursor-text relative z-10">
                        {showCourseComplete ? (
                            <CourseSummary history={history} onRestart={confirmReset} />
                        ) : isFinished ? (
                        <div className="text-center animate-in fade-in zoom-in duration-300 max-w-md mx-auto">
                            <div className={`inline-block p-5 rounded-full mb-6 ${isLevelComplete ? 'bg-yellow-100' : 'bg-green-100'}`}>
                            {isLevelComplete ? <AwardIcon className="w-16 h-16 text-yellow-600" /> : <CheckCircle2Icon className="w-16 h-16 text-green-600" />}
                            </div>
                            
                            <h2 className="text-3xl font-bold text-slate-800 mb-2">
                            {isLevelComplete 
                                ? (lang === 'km' ? "ឆ្លងវគ្គជោគជ័យ!" : "Level Complete!") 
                                : (lang === 'km' ? "ល្អណាស់!" : "Great Job!")}
                            </h2>
                            
                            <p className="text-slate-500 mb-8">
                            {isLevelComplete 
                                ? (lang === 'km' ? "អ្នកបានបញ្ចប់គ្រប់មេរៀនក្នុងវគ្គនេះ។" : "You finished all lessons in this level.")
                                : (lang === 'km' ? "ត្រៀមខ្លួនសម្រាប់មេរៀនបន្ទាប់។" : "Ready for the next text.")}
                            </p>

                            <div className="flex gap-4 justify-center mb-8 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <div className="text-center px-4 border-r border-slate-200">
                                <div className="text-2xl font-bold text-blue-600">{wpm}</div>
                                <div className="text-[10px] uppercase font-bold tracking-wider opacity-60">WPM</div>
                            </div>
                            <div className="text-center px-4">
                                <div className="text-2xl font-bold text-green-600">{accuracy}%</div>
                                <div className="text-[10px] uppercase font-bold tracking-wider opacity-60">Accuracy</div>
                            </div>
                            </div>

                            <button onClick={handleNext} className={`w-full py-4 text-white rounded-xl font-bold shadow-lg transition transform hover:-translate-y-0.5 flex items-center justify-center gap-2 cursor-pointer relative z-20 ${isLevelComplete ? 'bg-green-600 hover:bg-green-700 shadow-green-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'}`}>
                            {isLevelComplete 
                                ? (lang === 'km' ? "ចូលទៅកាន់វគ្គថ្មី" : "Start Next Level")
                                : (lang === 'km' ? "មេរៀនបន្ទាប់" : "Next Text")}
                            <ChevronRightIcon className="w-5 h-5" />
                            </button>
                        </div>
                        ) : (
                        <div className={`${fontStyle} tracking-wide select-none break-words w-full`}>
                            {renderText()}
                        </div>
                        )}
                    </div>

                    <textarea
                        ref={inputRef}
                        value={userInput}
                        onChange={handleChange}
                        onKeyDown={handleKeyDown}
                        className={`absolute opacity-0 top-0 left-0 w-full h-full cursor-default resize-none ${isFinished ? 'hidden' : 'block'}`}
                        autoFocus
                        autoComplete="off"
                        autoCorrect="off"
                        spellCheck="false"
                        disabled={isFinished}
                    />
                    </div>
                </main>
                </div>
            );
        }

        // --- STAT CARD COMPONENT ---
        function StatCard({ label, value, color, icon }) {
            return (
                <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col items-center justify-center relative overflow-hidden group">
                <div className="absolute top-2 right-2 opacity-50">{icon}</div>
                <span className="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">{label}</span>
                <span className={`text-3xl font-bold ${color}`}>{value}</span>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
